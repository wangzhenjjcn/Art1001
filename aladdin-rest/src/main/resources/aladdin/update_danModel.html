<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>上传单品模型</title>
    <link rel="stylesheet" href="css/common.css" charset="utf-8"/>
    <link rel="stylesheet" href="css/upload_model.css" charset="utf-8"/>
    <link rel="stylesheet" href="css/upload_danModel.css" charset="utf-8"/>
    <link rel="stylesheet" href="css/mark.css" charset="utf-8"/>
</head>
<body>
<div class="upload_model">
    <div class="load_header">上传单品模型</div>
    <h1>选择模型</h1>

    <div class="load_search">
        <input class="search_inp" placeholder="请输入单品模型名称" name="goodsName" class="radius" type="text"/>
        <span class="search_btn">搜索</span>
    </div>
    <h1>O R</h1>

    <div style="height: 50px;" class="set_model">
        <input type="hidden" name="m_brand" value=""/>
        

        <input type="hidden" name="m_cat" value=""/>

        <div style="display: block!important;float: left;" id="category_m_tpl" class="fenLei">

            <script id="category_tpl" type="text/juicer">
                <em>类别</em>
                <ul style="" class="nav1 clearfix">
                        <li onclick="selectCatagory(0)">
                            <span>全部</span>
                        </li>
                    {@each data as it,index}
                    <li>
                    <span>${it.gc_name}</span>
                        <ul class="nav2">

                            {@each it.categoryVOs as it2,index2}
                            <li class="">
                                <span>${it2.gc_name}</span>
                                    <ul class="nav3">
                                        {@each it2.categoryVOs as it3,index3}
                                        <li  onclick="selectCatagory('${it3.gc_id}')"><span>${it3.gc_name}</span></li>
                                        {@/each}
                                    </ul>
                            </li>
                             {@/each}
                        </ul>
                    </li>
                    {@/each}
                </ul>

            </script>

        </div>
        <div style="display: block!important;float: left;" id="brand_m_tpl" class="fenLei">

            <script id="brand_tpl" type="text/juicer">
                <em value="">品牌</em>
                <ul class="oneHeight nav1 clearfix">
                        <li onclick="selectBrand(0)">
                            <span >全部</span>
                        </li>
                    {@each data as it,index}
                        <li value="${it.brand_name}" onclick="selectBrand('${it.brand_id}')">
                            <span >${it.brand_name}</span>
                        </li>
                    {@/each}
                </ul>

            </script>

        </div>
    </div>
    <!--商品列表展示开始-->
    <div class="shopList_box">
        <div id="goods_m_tpl" class="shop_list_show radius">

            <script id="goods_tpl" type="text/juicer">

                {@each data as it,index}
                        <div class="shop_list" style="height:75px;" goods_id="${it.goods_id}">
                            <span class=""></span>
                            <dl>
                                <dt>
                                    <img src="${it.goods_image}" alt=""/>
                                    <b class="bs"></b>
                                </dt>
                                <dd style="height:75px;">
                                    <h2><em>名称 : </em>${it.goods_name}</h2>
                                    <h4><em>品牌 : </em>${it.brandName}</h4>
                                    <h3><em>规格 : </em>
                                        <select>
                                                        {@each it.skus as sku,index}
                                                        <option value="${sku.goodsSpecId}">${sku.skuName}</option>
                                                        {@/each}
                                        </select>
                                    </h3>
                                </dd>
                            </dl>
                        </div>
                    {@/each}
            </script>


        </div>
        <div class="load_page">
            <a class="prev_page" href="#">上一页</a>
            <a class="last_page" href="#">下一页</a>
        </div>
    </div>
    <!--商品列表展示结束-->
    <h1>选择区域</h1>

    <div class="area_choose">
        <p zonename="客餐厅"><img src="images/modelType_manager/area_icon1.png" alt=""/></p>

        <p zonename="主卧"><img src="images/modelType_manager/area_icon2.png" alt=""/></p>

        <p zonename="次卧"><img src="images/modelType_manager/area_icon3.png" alt=""/></p>

        <p zonename="厨房"><img src="images/modelType_manager/area_icon4.png" alt=""/></p>

        <p zonename="卫生间"><img src="images/modelType_manager/area_icon5.png" alt=""/></p>

        <p zonename="阳台"><img src="images/modelType_manager/area_icon6.png" alt=""/></p>
    </div>
    <h1>设置模型属性</h1>

    <div style="height: 150px;" class="set_model">
        <div class="fenLei" name="style">
            <em value="">风格</em>
            <ul id="a1" class="oneHeight nav1 clearfix">
                <li ><span value="中式">中式</span></li>
                <li ><span value="日式">日式</span></li>
                <li ><span value="美式">美式</span></li>
                <li ><span value="欧式">欧式</span></li>
                <li ><span value="混搭">混搭</span></li>
                <li ><span value="现代">现代</span></li>
                <li ><span value="古典">古典</span></li>
                <li ><span value="田园">田园</span></li>
                <li ><span value="地中海">地中海</span></li>
            </ul>
        </div>
        <div class="fenLei" name="color">
            <em value="">色系</em>
            <ul id="a2" class="oneHeight nav1 clearfix">
                <li ><span value="深色">深色</span></li>
                <li ><span value="中性">中性</span></li>
                <li ><span value="浅色">浅色</span></li>
            </ul>
        </div>
        <div class="fenLei" name="type">
            <em value="">模型类型</em>
            <ul id="a3" class="oneHeight nav1 clearfix">
                <li ><span value="none">无</span></li>
                <li ><span value="normal">普通家具</span></li>
                <li ><span value="wardrobe">衣柜</span></li>
                <li ><span value="skirting_board">踢脚截面</span></li>
                <li ><span value="3d_double_door">双开门</span></li>
                <li ><span value="3d_normal_door">普通门</span></li>
                <li ><span value="3d_sliding_door">移动门</span></li>
                <li ><span value="3d_zmm_out_door">子母门套</span></li>
                <li ><span value="3d_double_out_door">双开门套</span></li>
                <li ><span value="3d_single_out_door">单开门套</span></li>
                <li ><span value="gypsum_line">天花线脚</span></li>
            </ul>
        </div>
        <div class="fenLei" name="material">
            <em value="">材质类型</em>
            <ul id="a4" class="oneHeight nav1 clearfix">
                <li ><span value="none">无</span></li>
                <li ><span value="wall">壁纸</span></li>
                <li ><span value="floor">地板</span></li>
                <li ><span value="top">吊顶</span></li>
            </ul>
        </div>
        <div class="fenLei" name="stage">
            <em value="">阶段</em>
            <ul id="a5" class="oneHeight nav1 clearfix">
                <li ><span value="前期">前期</span></li>
                <li ><span value="水电">水电</span></li>
                <li ><span value="油漆">油漆</span></li>
                <li ><span value="泥瓦">泥瓦</span></li>
                <li ><span value="验收">验收</span></li>
            </ul>
        </div>
        <div class="fenLei" name="category">
            <em value="">工程分类</em>
            <ul id="a6" class="oneHeight nav1 clearfix">
                <li><span  value="天棚工程">天棚工程</span></li>
                <li ><span value="地面工程">地面工程</span></li>
                <li><span  value="墙面工程">墙面工程</span></li>
                <li ><span value="安装">安装</span></li>
            </ul>
        </div>
    </div>
    <div class="property_cont">
        <h5>
            <p>
                <label for="">尺寸 : </label>
                <input name="modelSize" class="radius" type="text"/>
            </p>

            <p>
                <label for="">材质 : </label>
                <input name="modelMaterial" class="radius" type="text"/>
            </p>

            <p>
                <label for="">人工费 : </label>
                <input name="unitpriceMan" class="radius" type="text"/>
            </p>

            <p>
                <label for="">材料费 : </label>
                <input name="unitpriceMaterial" class="radius" type="text"/>
            </p>

            <p>
                <label for="">搬运费 : </label>
                <input name="transportExpenses" class="radius" type="text"/>
            </p>

            <p>
                <label for="">安装费 : </label>
                <input name="installExpenses" class="radius" type="text"/>
            </p>

            <p>
                <label for="">损耗费 : </label>
                <input name="wastageRate" class="radius" type="text"/>
            </p>

            <p>
                <label for="">单价 : </label>
                <input name="unitprice" class="radius" type="text"/>
            </p>

            <p>
                <label for="">输出类型 : </label>
                <select name="exportType" class="radius">
                    <option value="construction">施工</option>
                    <option value="auxiliary_material">辅材</option>
                    <option value="main_material">主材</option>
                </select>
                <!--<input name="exportType" class="radius" type="hidden"/>-->
            </p>
            <div>
                <h6 name="autoApply">
                <em>是否自动应用</em>
                <span class="checking" v="1">是</span>
                <span v="0">否</span>
            </h6>
            </div>
        </h5>
        <!-- <h6 name="autoApply">
            <em>是否自动应用</em>
            <span class="checking" v="1">是</span>
            <span v="0">否</span>
        </h6> -->
    </div>
    <div class="handle_btn">
        <p>
            <input class="reset" type="button" value="取消"/>
            <input class="submit" type="button" value="提交"/>
        </p>
    </div>
    <div class="mark"><img src="images/modelType_manager/loadings.gif" alt=""/></div>

</div>
</body>
</html>
<script src="js/jquery-1.12.1.min.js"></script>
<script src="js/jquery.cookie.js" charset="utf-8"></script>
<script src="js/juicer-min.js"></script>
<script src="js/module/core/main.js"></script>
<script src="js/module/core/user.js"></script>
<script src="js/module/skp/core.js" charset="utf-8"></script>
<script src="js/module/skp/skp.js" charset="utf-8"></script>
<script>
    var $accessibility=3;//表示模型共享
    //获取商品信息
    var goods_tpl = document.getElementById('goods_tpl').innerHTML;

    var pageNum = 1;//当前页面
    var totalPage=1;//总页码
    var pageSize = 10;

    $(function () {

        //选择区域
        $('.area_choose').on('click','p',function(){
//            $(this).siblings().removeClass('check');
            if($(this).hasClass('check')){
                $(this).removeClass('check')
            }else{
                $(this).addClass('check')
            }
        });



        //单选
        $('.shop_list_show').on('click', 'span', function () {
            $(this).parent('.shop_list').siblings().find('span').removeClass('shop_check');
            if($(this).hasClass('shop_check')){
                $(this).removeClass('shop_check')
            }else{
                $(this).addClass('shop_check')
            }
        });

        //搜索显示列表loading
        $('.search_btn').on('click', function () {
            loadShow();
            //test('.shopList_box');
        });
        $(".search_inp").on("keypress",function(event){
            if(event.keyCode==13){
                loadShow();
            }
        })

        //点击上一页loading
        $('.prev_page').on('click', function () {
            if(pageNum>1){
                pageNum=pageNum-1;
                pageNum=pageNum<1?1:pageNum;
                loadShow();
            }
        });

        //下一页loading
        $('.last_page').on('click', function () {
            if(pageNum<totalPage){
                pageNum=pageNum+1;
                pageNum=pageNum>totalPage?totalPage:pageNum;
                loadShow();
            }
        });

        //是否自动应用单选
        $('.property_cont h6').on('click', 'span', function () {
            $(this).parent().find('span').removeClass('checking');
            $(this).addClass('checking');
        });


        $('.submit').on('click',function(){
            subinfo();
        });


        $('.reset').on('click',function(){
            skp_window_close();
        });


        //function init_category_event() {

            //点击分类菜单
            $('.set_model').on('mouseenter', '.fenLei', function () {
                $(this).find('.nav1').show();
            }).on("mouseleave", '.fenLei', function () {
                $(".nav1").hide();
            });

            //显示二级
            $(document).on('mouseenter', '.set_model .nav1>li', function () {
                $(this).addClass('active_li').siblings().removeClass('active_li');
                $(this).siblings().find('ul').hide();
                $(this).children('ul').show();
            }).on("mouseleave", '.set_model .nav1>li', function () {
                $(this).children('ul').hide();
                $(this).removeClass('active_li');
            });

            //显示三级
            $(document).on('mouseenter', '.set_model .nav1>li li', function () {
                $(this).addClass('active_li').siblings().removeClass('active_li');
                $(this).siblings().find('ul').hide();
                $(this).children('ul').show();
            });
        
        //点击
        $(document).on('click','.set_model .nav3 li', function (e) {
            e.stopPropagation();
            var text = $(this).children('span').text();

//            console.log(text);
            var parentDom = $(this).parents('.fenLei');
//            console.log( parentDom.children('em').text() )
//            console.log( parentDom.attr('id') )
            parentDom.children('em').text( text );

            //$(':hidden[name=m_cat]').val(text);
            $(".nav1").hide();
        });
        //点击
        $(document).on('click','.set_model .oneHeight li', function (e) {
            e.stopPropagation();
            var text = $(this).children('span').text();
            var value = $(this).children('span').attr("value");
//            console.log(text);
            var parentDom = $(this).parents('.fenLei');
//            console.log( parentDom.children('em').text() )
//            console.log( parentDom.attr('id') )
            parentDom.children('em').text( text );
            parentDom.children('em').attr("value",value);
            //$(':hidden[name=m_cat]').val(text);
            $(".nav1").hide();
        });





        loadBrand();
        loadCategory();
        //init_category_event();




    });



    //---------------------------------------------------------------------------------

    //loading
    function loadShow(className) {
        var flag = true;
        $('.mark').show();

        loadGoods();

        setTimeout(function () {
            $('.mark').fadeOut();

            if (className) {//如果有参数 用传进来的参数，
                hideloading(className);
            } else {
                hideloading('.shopList_box');
            }

        }, 600);
    }

    function hideloading(className) {
        setTimeout(function () {
            $('.mark').stop().fadeOut();
            $(className).stop().fadeIn();
        }, 300)
    }
    //加载品牌
    function loadBrand() {
        var barnd_tpl = document.getElementById('brand_tpl').innerHTML;
        var obj = {};
        var url = brand_list_url;
        $.fn.mypost(url,obj,getUserToken(),function(response){
            //console.log(response);
            response = my_eval(response);
            var code = response.code;
            if (code == 200) {
                var tpl_html = juicer(barnd_tpl, response);//模板赋值
                $("#brand_m_tpl").empty();
                $("#brand_m_tpl").html(tpl_html);

            } else {
                alert("服务器错误，请稍后重试");
            }
        });

    }

    //加载分类信息
    function loadCategory() {
        var category_tpl = document.getElementById('category_tpl').innerHTML;
        var obj = {};
        var url = category_list_url;
        $.fn.mypost(url,obj,getUserToken(),function(response){
            //console.log(response);
            response = my_eval(response);
            var code = response.code;
            if (code == 200) {
                var tpl_html = juicer(category_tpl, response);//模板赋值
                $("#category_m_tpl").empty();
                $("#category_m_tpl").html(tpl_html);

            } else {
                alert("服务器错误，请稍后重试");
            }
        });

    }

    function selectBrand(id) {
        $(":hidden[name=m_brand]").val(id);
        loadShow();
    }

    function selectCatagory(id){
        $(":hidden[name=m_cat]").val(id);
        loadShow();
    }

    //加载商品信息
    function loadGoods() {

        var name=$("[name=goodsName]").val();//商品名称
        var bid=$("[name=m_brand]").val();//品牌
        if(bid==0){
            bid = "";
        }
        var cid=$(":hidden[name='m_cat']").val();//类别

        if(cid==0){
            cid = "";
        }
        
        var obj = {"pageNo":pageNum,"pageSize":pageSize,"name":name,"cid":cid,"bid":bid};
        var url = goods_list_url;
        $.fn.mypost(url,obj,getUserToken(),function(response){
            //console.log(response);
            if(response.data.length<1){
                alert("搜索的商品不存在");
                return;
            }
            response = my_eval(response);
            var code = response.code;
            if (code == 200) {
                totalPage=response.maxPages;
                totalPage=totalPage==0?1:totalPage;
                var tpl_html = juicer(goods_tpl, response);//模板赋值

                $("#goods_m_tpl").empty();
                $("#goods_m_tpl").html(tpl_html);
                // $('.mark').fadeOut();
            } else {
                alert("服务器错误，请稍后重试");
            }
        });

    }

    /*添加模型数据*/
    function subinfo(){
        //验证表单
        if(verifydata()==false){
            return false;
        }
        skp_upload_model_file(); 
      /*   var response = '{"code":200, "msg":"SUCCESS", "skp":"http://art1001.oss-cn-shanghai.aliyuncs.com/d058de63-a5b3-42b9-b140-7dbbc5b8857a.skp", "png":"http://art1001.oss-cn-shanghai.aliyuncs.com/dbfcdea0-8aaa-4ba3-b42d-05a83b80b829.png"}';
        upload_callback(response);  */
    }

    //获取模型相关数据
    var modeldata=function(thumbId,skpId){

        var goodsId='';
        var skuId='';
        var modelnumber = '';
        $(".shop_list").each(function(){
            if($(this).find("span").hasClass('shop_check')){
                if(typeof($(this).attr('goods_id'))!='undefined'){
                    goodsId=$(this).attr('goods_id');
                }
                if(typeof $(this).find("select")!="undefined"){
					skuId = $(this).find("select").val();
					modelnumber = $.trim($(this).find("select").text());
                }
                return false;
            }
        });

        var modelFunctions="";
        $(".area_choose p").each(function(){
            if($(this).hasClass('check')){
                modelFunctions+=$(this).attr('zonename')+',';
            }
        });
        if(modelFunctions!=''){
            modelFunctions=modelFunctions.substr(0,modelFunctions.length-1);
        }
        var style=$(".set_model [name=style] em").attr("value");//风格
        var color=$(".set_model [name=color] em").attr("value");//色系
        var type=$(".set_model [name=type] em").attr("value");//模型类型
        var material=$(".set_model [name=material] em").attr("value");//材质类型
        if(material!="none"){
            type = "none";
        }
        var stage=$(".set_model [name=stage] em").attr("value");//阶段
        var category=$(".set_model [name=category] em").attr("value");//模型分类


        var modelSize=$('[name="modelSize"]').val();
        var modelMaterial=$('[name="modelMaterial"]').val();
        var unitpriceMan=$('[name="unitpriceMan"]').val();
        var unitpriceMaterial=$('[name="unitpriceMaterial"]').val();
        var transportExpenses=$('[name="transportExpenses"]').val();
        var installExpenses=$('[name="installExpenses"]').val();
        var wastageRate=$('[name="wastageRate"]').val();
        var unitprice=$('[name="unitprice"]').val();
        var exportType=$('[name="exportType"] option:selected').val();
        var autoApply=$('[name="autoApply"] .checking').attr('v');

        var data={
            "goodsId":goodsId,
            "skuId":skuId,
            "modelnumber":modelnumber,
            "modelFunctions":modelFunctions,
            "style":style,
            "color":color,
            "type":type,
            "material":material,
            "stage":stage,
            "category":category,
            "modelSize":modelSize,
            "modelMaterial":modelMaterial,
            "unitpriceMan":unitpriceMan,
            "unitpriceMaterial":unitpriceMaterial,
            "transportExpenses":transportExpenses,
            "installExpenses":installExpenses,
            "wastageRate":wastageRate,
            "unitprice":unitprice,
            "exportType":exportType,
            "autoApply":autoApply,
            "accessibility":$accessibility,
            "thumbId":thumbId,
            "skpId":skpId
        }
        return data;

    }

    //sketch-up回调
    function upload_callback(response){

        var thumbId = "";
        var skpId = "";

        if(response){
            var data = eval('(' + response + ')');
            var code = data.code;
            if(code==200){
                if(data.skp!=""){
                    skpId = data.skp;
                }
                if(data.png!=""){
                    thumbId = data.png;
                }
            }
        }

        var data=modeldata(thumbId,skpId);

        var url = models_upload_url;
        $.fn.mypost(url,data,getUserToken(),function(response){
            //console.log(response);
            response = my_eval(response);
            if(response.code==200) {
                alert("上传成功!");
                setTimeout(function () {
                    ART.Sketchup.callback("Window.close");
                }, 2000);
            }else
            {
                alert("服务器错误，请稍后重试");
            }
        });

    }

    //验证表单数据
    function verifydata(){
        var data=modeldata("","");
        if(data.goodsId==""){
            alert("请选择模型商品");
            return false;
        }
        if(data.skuId==""){
            alert("请选择模型规格");
            return false;
        }
        if(data.modelFunctions==""){
            alert("请选择区域");
            return false;
        }
        if(data.style=="风格"){
            alert("请选择风格");
            return false;
        }
        if(data.color=="色系"){
            alert("请选择色系");
            return false;
        }
        if(data.type=="模型类型"){
            alert("请选择模型类型");
            return false;
        }
        if(data.material=="材质类型"){
            alert("请选择材质类型");
            return false;
        }
        if(data.stage=="阶段"){
            alert("请选择阶段");
            return false;
        }
        if(data.category=="工程分类"){
            alert("请选择工程分类");
            return false;
        }
        if(data.modelSize==""){
            alert("尺寸不能为空");
            return false;
        }
        if(data.modelMaterial==""){
            alert("材质不能为空");
            return false;
        }
        if(data.unitpriceMan==""){
            alert("人工费不能为空");
            return false;
        }
        if(data.unitpriceMaterial==""){
            alert("材料费不能为空");
            return false;
        }
        if(data.transportExpenses==""){
            alert("搬运费不能为空");
            return false;
        }
        if(data.installExpenses==""){
            alert("安装费不能为空");
            return false;
        }
        if(data.wastageRate==""){
            alert("损耗费不能为空");
            return false;
        }
        if(data.unitprice==""){
            alert("单价不能为空");
            return false;
        }
//        if(data.exportType==""){
//            alert("输出类型不能为空");
//            return false;
//        }
        var reg=/^([1-9]\d*|0)(.\d{2})?$/;
        if(!(reg.test(data.unitpriceMan))){
            alert("请输入正确的人工费");
            return false;
        }
        if(!(reg.test(data.unitpriceMaterial))){
            alert("请输入正确的材料费");
            return false;
        }
        if(!(reg.test(data.transportExpenses))){
            alert("请输入正确的搬运费");
            return false;
        }
        if(!(reg.test(data.installExpenses))){
            alert("请输入正确的安装费");
            return false;
        }
        if(!(reg.test(data.wastageRate))){
            alert("请输入正确的损耗费");
            return false;
        }
        if(!(reg.test(data.unitprice))){
            alert("请输入正确的单价");
            return false;
        }
        return true;

    }
  


</script>
</body>
</html>